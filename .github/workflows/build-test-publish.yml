name: Build, Test & Publish NuGet

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  release:
    types: [ published ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/Valdiated.Primatives/Validated.Primitives.csproj'
  TEST_PROJECT_PATH: 'tests/Valdiated.Primatives.Tests/Validated.Primitives.Tests.csproj'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for version calculation
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Calculate Version
      id: version
      run: |
        # Get the base version from the csproj file
        BASE_VERSION=$(grep -oPm1 "(?<=<Version>)[^<]+" ${{ env.PROJECT_PATH }})
        echo "Base version: $BASE_VERSION"
        
        # Calculate build number from commit count
        COMMIT_COUNT=$(git rev-list --count HEAD)
        
        # Extract major.minor from base version
        MAJOR_MINOR=$(echo $BASE_VERSION | cut -d '.' -f 1-2)
        
        # Create version with auto-increment
        # Format: major.minor.buildNumber
        VERSION="$MAJOR_MINOR.$COMMIT_COUNT"
        
        # If this is a release, use the tag version instead
        if [[ "${{ github.event_name }}" == "release" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
        fi
        
        echo "Calculated version: $VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_OUTPUT
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release --no-restore /p:Version=${{ steps.version.outputs.VERSION }} /p:CI=true
    
    - name: Test
      run: dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
    
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always() && github.event_name == 'pull_request'
      with:
        name: Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: false
    
    - name: Pack NuGet Package
      if: github.event_name != 'pull_request'
      run: |
        dotnet pack ${{ env.PROJECT_PATH }} \
          --configuration Release \
          --no-build \
          --output ./artifacts \
          /p:Version=${{ steps.version.outputs.VERSION }} \
          /p:PackageVersion=${{ steps.version.outputs.VERSION }} \
          /p:CI=true
    
    - name: Upload NuGet Package Artifact
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package
        path: ./artifacts/*.nupkg
        retention-days: 30
    
    - name: Upload Symbol Package Artifact
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: symbol-package
        path: ./artifacts/*.snupkg
        retention-days: 30

  publish-nuget:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: |
      github.event_name == 'release' || 
      (github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'))
    
    steps:
    - name: Download NuGet Package
      uses: actions/download-artifact@v4
      with:
        name: nuget-package
        path: ./artifacts
    
    - name: Download Symbol Package
      uses: actions/download-artifact@v4
      with:
        name: symbol-package
        path: ./artifacts
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Publish to NuGet.org
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        dotnet nuget push ./artifacts/*.nupkg \
          --api-key $NUGET_API_KEY \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate
    
    - name: Publish Symbols to NuGet.org
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        dotnet nuget push ./artifacts/*.snupkg \
          --api-key $NUGET_API_KEY \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

  publish-github-packages:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    permissions:
      packages: write
      contents: read
    
    steps:
    - name: Download NuGet Package
      uses: actions/download-artifact@v4
      with:
        name: nuget-package
        path: ./artifacts
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Publish to GitHub Packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        dotnet nuget push ./artifacts/*.nupkg \
          --api-key $GITHUB_TOKEN \
          --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
          --skip-duplicate
